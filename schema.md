| #     | Микросервис / БД<br>(свой `DbContext`)                          | **Сущности (DbSet<>)**<br>*(PostgreSQL 14 типы)*                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Получает события                       | Публикует события                                           | Стек внутри сервиса                                                                      | REST / gRPC, куда обращается **BFF**          |
| ----- | --------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------- | ----------------------------------------------------------- | ---------------------------------------------------------------------------------------- | --------------------------------------------- |
| **1** | **auth-service**<br>`auth_db` → `AuthContext`                   | **User** `{ Id uuid PK, Email citext U, PasswordHash text, FullName text, CreatedAt timestamptz, IsActive bool }`<br>**Role** `{ Id smallserial PK, Name text U }`<br>**UserRole** `{ UserId uuid PK FK, RoleId smallint PK FK }`<br>**RefreshToken** `{ Token uuid PK, UserId uuid FK, ExpiresAt timestamptz, IssuedAt timestamptz, UserAgent text, IpAddress inet }`                                                                                                                                                                                                                                                                                                   | –                                      | `UserCreatedV1` *(когда регистрируется новый пользователь)* | • ASP.NET Core 8<br>• EF Core 8 + Npgsql<br>• RabbitMQ outbox<br>• JWT                   | `/auth/login` `/auth/register`                |
| **2** | **upload-service**<br>`upload_db` → `StorageContext`            | **AudioFile** `{ Id uuid PK, OriginalName text, FileName text, StorageKey text U, ContentType text, FileSize bigint, UploadDate timestamptz, UploaderId uuid, Status text(16) }`<br>**OutboxMessage** `{ Id bigserial PK, Type text, Payload jsonb, OccurredOnUtc timestamptz, Processed bool }`                                                                                                                                                                                                                                                                                                                                                                         | –                                      | `FileUploadedV1`                                            | • ASP.NET Core (minimal-api)<br>• EF Core 8<br>• MinIO / S3 SDK<br>• RabbitMQ outbox     | `/upload` *(multipart POST)*                  |
| **3** | **processing-service**<br>`processing_db` → `ProcessingContext` | **ProcessingJob** `{ Id bigserial PK, AudioFileId uuid, ModelUsed text, StartedAt timestamptz?, FinishedAt timestamptz?, Status text(16), ErrorMessage text? }`<br>**OutboxMessage**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `FileUploadedV1`                       | `FileProcessedV1`                                           | • WorkerService<br>• EF Core 8 + Dapper<br>• gRPC → Python(Denoise)<br>• RabbitMQ outbox | нет REST; BFF не ходит напрямую               |
| **4** | **transcription-service**<br>`stt_db` → `TranscriptionContext`  | **TranscriptionJob** `{ Id bigserial PK, AudioFileId uuid, ModelUsed text, Language text, StartedAt timestamptz?, FinishedAt timestamptz?, Status text(16), ErrorMessage text? }`<br>**OutboxMessage**                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `FileUploadedV1`                       | `TranscriptReadyV1`                                         | • WorkerService<br>• EF Core 8<br>• gRPC → Python(Whisper/Vosk)<br>• RabbitMQ outbox     | нет REST                                      |
| **5** | **metadata-service**<br>`meta_db` → `MetadataContext`           | **Song** `{ Id uuid PK, Title text, Description text?, Year smallint?, DurationSec int?, CreatedAt timestamptz, UpdatedAt timestamptz }`<br>**Author** `{ Id uuid PK, FullName text, BirthYear smallint?, DeathYear smallint?, Notes text? }`<br>**SongAuthor** `{ SongId uuid PK FK, AuthorId uuid PK FK, Role text PK }`<br>**Tag** `{ Id smallserial PK, Name text U, Approved bool }`<br>**SongTag** `{ SongId uuid FK, TagId smallint FK, PK(SongId,TagId) }`<br>**Transcript** `{ Id bigserial PK, SongId uuid FK, SegmentIndex int, StartMs int, EndMs int, Text text, Confidence numeric(5,4), CheckedById uuid?, CheckedAt timestamptz? }`<br>**OutboxMessage** | `FileProcessedV1`, `TranscriptReadyV1` | `SongUpdatedV1`                                             | • ASP.NET Core + EF Core 8<br>• RabbitMQ outbox<br>• MediatR for domain events           | `/songs`, `/authors`, `/tags`, `/transcripts` |
| **6** | **search-service**<br>ElasticSearch 7.x                         | **SongSearchDocument** *(index)*                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `SongUpdatedV1`                        | –                                                           | • ASP.NET Core Worker<br>• NEST client<br>• RabbitMQ consumer                            | `/search/text`, `/search/filter`              |
